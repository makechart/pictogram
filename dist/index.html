<div><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="legend">&nbsp;</div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:1fr fit-content(10em);grid-template-rows:1fr;padding:0 .5em}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-column:2;grid-row:1/span 1;padding-left:1em}.pdl-layout.legend-bottom>div[data-type=layout]{grid-template-columns:1fr;grid-template-rows:1fr fit-content(3em)}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=legend]{padding-top:1em;grid-column:1/span 1;grid-row:2}</style><script type="@plotdb/block">var utils,sampleIcon,mod;utils={};utils.preproc=function(t){var e,n,i,a,r,l,u,s,c,d,o,g;e=t.canvas,n=t.light;i=e.getContext("2d");a=i.getImageData(0,0,e.width,e.height);r=a.data;l=[];for(u=0,c=(s=h()).length;u<c;u+=4){d=s[u];o=.299*r[d]+.587*r[d+1]+.114*r[d+2];if(r[d+3]){l.push(o)}}l.sort(function(t,e){if(t<e){return-1}else if(t>e){return 1}else{return 0}});n=l[(s=Math.floor(n*l.length))<(g=l.length-1)?s:g];for(u=0,c=(s=m()).length;u<c;u+=4){d=s[u];o=.299*r[d]+.587*r[d+1]+.114*r[d+2];if(o<=n){r[d]=0;r[d+1]=0;r[d+2]=0}else{r[d]=255;r[d+1]=255;r[d+2]=255}}return i.putImageData(a,0,0);function h(){var t,e,n=[];for(t=0,e=r.length-4;t<=e;++t){n.push(t)}return n}function m(){var t,e,n=[];for(t=0,e=r.length-4;t<=e;++t){n.push(t)}return n}};sampleIcon="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48c3ZnIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDBweCIgaGVpZ2h0PSIyMDBweCIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHN0eWxlPSJ3aWR0aDoxMDAlO2hlaWdodDoxMDAlO2JhY2tncm91bmQtc2l6ZTppbml0aWFsO2JhY2tncm91bmQtcmVwZWF0LXk6aW5pdGlhbDtiYWNrZ3JvdW5kLXJlcGVhdC14OmluaXRpYWw7YmFja2dyb3VuZC1wb3NpdGlvbi15OmluaXRpYWw7YmFja2dyb3VuZC1wb3NpdGlvbi14OmluaXRpYWw7YmFja2dyb3VuZC1vcmlnaW46aW5pdGlhbDtiYWNrZ3JvdW5kLWNvbG9yOmluaXRpYWw7YmFja2dyb3VuZC1jbGlwOmluaXRpYWw7YmFja2dyb3VuZC1hdHRhY2htZW50OmluaXRpYWw7YW5pbWF0aW9uLXBsYXktc3RhdGU6cGF1c2VkIiA+PGcgY2xhc3M9ImxkbC1zY2FsZSIgc3R5bGU9InRyYW5zZm9ybS1vcmlnaW46NTAlIDUwJTt0cmFuc2Zvcm06cm90YXRlKDBkZWcpIHNjYWxlKDEsIDEpO2FuaW1hdGlvbi1wbGF5LXN0YXRlOnBhdXNlZCIgPjxjaXJjbGUgZmlsbD0iIzg0OWI4NyIgcj0iMTAuODc2IiBjeT0iMTUuODc2IiBjeD0iNTAiIHN0eWxlPSJmaWxsOnJnYigyOSwgMTQsIDExKTthbmltYXRpb24tcGxheS1zdGF0ZTpwYXVzZWQiID48L2NpcmNsZT4KPGcgc3R5bGU9ImFuaW1hdGlvbi1wbGF5LXN0YXRlOnBhdXNlZCIgPjxwYXRoIGZpbGw9IiM4NDliODciIGQ9Ik02OC43NjQgNTguNjM1YTMuOTg1IDMuOTg1IDAgMCAxLTMuOTg1LTMuOTg1di02LjY0MmMwLTguMTQ5LTYuNjMtMTQuNzc5LTE0Ljc3OS0xNC43NzlzLTE0Ljc3OSA2LjYzLTE0Ljc3OSAxNC43Nzl2Ni42NDJhMy45ODUgMy45ODUgMCAxIDEtNy45NyAwdi02LjY0MmMwLTEyLjU0NCAxMC4yMDUtMjIuNzQ5IDIyLjc0OS0yMi43NDlzMjIuNzQ5IDEwLjIwNSAyMi43NDkgMjIuNzQ5djYuNjQyYzAgMi4yLTEuNzg0IDMuOTg1LTMuOTg1IDMuOTg1eiIgc3R5bGU9ImZpbGw6cmdiKDI5LCAxNCwgMTEpO2FuaW1hdGlvbi1wbGF5LXN0YXRlOnBhdXNlZCIgPjwvcGF0aD48L2c+CjxwYXRoIGQ9Ik0zOC40MTcgMzIuMTY3aDIzLjE2N3YzMy42NjdIMzguNDE3eiIgZmlsbD0iIzg0OWI4NyIgc3R5bGU9ImZpbGw6cmdiKDI5LCAxNCwgMTEpO2FuaW1hdGlvbi1wbGF5LXN0YXRlOnBhdXNlZCIgPjwvcGF0aD4KPHBhdGggZmlsbD0iIzg0OWI4NyIgZD0iTTQzLjM5OSA1My40ODdhNC45NCA0Ljk0IDAgMCAwLTQuOTQgNC45NFY5MC4wNmE0Ljk0IDQuOTQgMCAwIDAgOS44OCAwVjU4LjQyN2E0Ljk0IDQuOTQgMCAwIDAtNC45NC00Ljk0eiIgc3R5bGU9ImZpbGw6cmdiKDI5LCAxNCwgMTEpO2FuaW1hdGlvbi1wbGF5LXN0YXRlOnBhdXNlZCIgPjwvcGF0aD4KPHBhdGggZmlsbD0iIzg0OWI4NyIgZD0iTTU2LjYwMSA1My40ODdhNC45NCA0Ljk0IDAgMCAxIDQuOTQgNC45NFY5MC4wNmE0Ljk0IDQuOTQgMCAwIDEtOS44OCAwVjU4LjQyN2E0Ljk0IDQuOTQgMCAwIDEgNC45NC00Ljk0eiIgc3R5bGU9ImZpbGw6cmdiKDI5LCAxNCwgMTEpO2FuaW1hdGlvbi1wbGF5LXN0YXRlOnBhdXNlZCIgPjwvcGF0aD4KPG1ldGFkYXRhIHhtbG5zOmQ9Imh0dHBzOi8vbG9hZGluZy5pby9zdG9jay8iIHN0eWxlPSJhbmltYXRpb24tcGxheS1zdGF0ZTpwYXVzZWQiID48ZDpuYW1lIHN0eWxlPSJhbmltYXRpb24tcGxheS1zdGF0ZTpwYXVzZWQiID5tYW48L2Q6bmFtZT4KCgo8ZDp0YWdzIHN0eWxlPSJhbmltYXRpb24tcGxheS1zdGF0ZTpwYXVzZWQiID5tYW4scGVvcGxlLGNoYXJhY3RlcixwZXJzb24sZmlndXJlLGlkb2wsZG9sbDwvZDp0YWdzPgoKCjxkOmxpY2Vuc2Ugc3R5bGU9ImFuaW1hdGlvbi1wbGF5LXN0YXRlOnBhdXNlZCIgPmJ5PC9kOmxpY2Vuc2U+CgoKPGQ6c2x1ZyBzdHlsZT0iYW5pbWF0aW9uLXBsYXktc3RhdGU6cGF1c2VkIiA+bXE1dXg8L2Q6c2x1Zz48L21ldGFkYXRhPjwvZz48IS0tIGdlbmVyYXRlZCBieSBodHRwczovL2xvYWRpbmcuaW8vIC0tPjwvc3ZnPg==";module.exports={pkg:{name:"pictogram",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[{name:"ldfile",version:"main",path:"index.min.js"},{name:"potrace-wasm",version:"main",path:"index.js",global:true}],i18n:{}},init:function(t){var e,n,i,a;e=t.root,n=t.ctx,i=t.t,a=t.pubsub;return a.fire("init",{mod:mod({ctx:n,t:i})})}};mod=function(t){var e,n,i,o,a,r,g,l;e=t.ctx,n=t.t;i=e.chart,o=e.d3,a=e.debounce,r=e.ldfile,g=e.loadFromCanvas;utils.traceSvg=function(n){return new Promise(function(l,u){var s,c,t,d,e;s=n.size||256;c=n.light||.5;t=n.file;d=new Image;d.onload=function(){var t,e,n,i,a,r;t=document.createElement("canvas");e=t.getContext("2d");n=Math.min(s/d.width,s/d.height);t.width=s;t.height=s;i=[d.width*n,d.height*n],a=i[0],r=i[1];e.drawImage(d,(s-a)/2,(s-r)/2,a,r);utils.preproc({canvas:t,light:c});return g(t,{}).then(function(t){return l(t)})["catch"](function(t){return u(t)})};if(typeof t==="string"){return d.src=t}else{e=new FileReader;e.onload=function(){return d.src=e.result};return e.readAsDataURL(t)}})};return{sample:function(){return{raw:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100].map(function(t){return{name:"N-"+t,cat:"Type "+Math.ceil(Math.random()*4),value:Math.ceil(Math.random()*3)}}),binding:{cat:{key:"cat"},name:{key:"name"}}}},config:(l=i.utils.config.from({preset:"default",legend:"legend",tip:"tip"}),l.shape={glyph:{type:"upload"},threshold:{type:"number",default:.5,min:0,max:1,step:.01}},l.padding={type:"number",default:0,min:-1,max:1,step:.01},l),dimension:{value:{type:"R"},cat:{type:"C"},name:{type:"N"}},init:function(){var e,n=this;this.tint=e=new i.utils.tint;this.g=Object.fromEntries(["view","legend"].map(function(t){return[t,o.select(n.layout.getGroup(t))]}));this.g.defs=o.select(this.svg).append("g").attr("class","defs");this.defs=this.g.defs.append("defs");this.tip=new i.utils.tip({root:this.root,accessor:function(t){var e,n;e=t.evt;if(!(e.target&&(n=o.select(e.target).datum()))){return null}return{name:(n.cat?n.cat+" / ":"")+(n.name||""),value:""}},range:function(){return n.layout.getNode("view").getBoundingClientRect()}});this.legend=new i.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return o.select(this).attr("fill",e.get(t.key))}});return this.legend.on("select",function(){n.parse();n.bind();n.resize();return n.render()})},destroy:function(){if(this.tip){return this.tip.destroy()}},parse:function(){var n,t,e,i,a,r=this;n={};if(this.binding.cat){this.data.map(function(t){return n[t.cat]=true});t=[];for(e in n){i=n[e];t.push(e)}this.cats=t;if(this.binding.value!=null){a=this.data.map(function(t){var e,n,i,a=[];for(e=0,n=t.value;e<n;++e){i=e;a.push({cat:t.cat,name:t.name})}return a}).reduce(function(t,e){return t.concat(e)},[])}else{a=this.data}}else{n[""]=true;this.cats=[];if(this.binding.value!=null){a=this.data.map(function(t){var e,n,i,a=[];for(e=0,n=t.value;e<n;++e){i=e;a.push({cat:"",name:t.name})}return a}).reduce(function(t,e){return t.concat(e)},[])}else{a=this.data.map(function(t){return{cat:"",name:t.name}})}}a.map(function(t,e){return t._idx=e});this.cats.sort();this.legend.data(this.cats.map(function(t){return{key:t,text:t}}));this.parsed=a.filter(function(t){return!r.cats.length||!r.cfg.legend.enabled||r.legend.isSelected(t.cat)});this.parsed.map(function(t){return t._removing=false});this.parsed.sort(function(t,e){if(n[t.cat]<n[e.cat]){return 1}else if(n[t.cat]>n[e.cat]){return-1}return t.cat<e.cat?-1:t.cat>e.cat?1:0});this.parsed.map(function(t,e){return t._order=e});return this.sum=this.parsed.length},resize:function(){var t;this.tip.toggle(((t=this.cfg).tip||(t.tip={})).enabled!=null?this.cfg.tip.enabled:true);this.legend.config(this.cfg.legend);this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",this.cfg.legend.position==="bottom");this.legend.update();this.layout.update(false);return this.tint.set(this.cfg.palette.colors.map(function(t){return t.value||t}))},render:function(){var a,u,t,e,n,s,i,c,d,r,l=this;a=this.tint,u=this.cfg;t=Math.round(Math.sqrt(this.sum));e=[t||1,Math.ceil(this.sum/t)||1],n=e[0],s=e[1];i=this.layout.getBox("view");e=[i.width/s,i.height/n],c=e[0],d=e[1];r=this.g.view.selectAll("g.data").data(this.parsed,function(t){return t._idx});r.exit().each(function(t,e){t._removing=true;return o.select(this).select("use.data").transition().duration(150).attr("x",c/2).attr("y",c/2).attr("opacity",0).attr("transform","scale(0,0)")});r.exit().transition().delay(150).remove();r.enter().append("g").attr("class","data").attr("transform",function(t,e){var n,i,a,r;n=t._order;i=[c*(n%s),d*Math.floor(n/s)],a=i[0],r=i[1];return"translate("+a+", "+r+")"}).append("use").attr("class","data").attr("opacity",0).attr("x",c/2).attr("y",d/2).attr("transform","scale(0,0)");this.g.view.selectAll("g.data").transition().duration(350).attr("transform",function(t,e){var n,i,a,r,l;n=u.padding||0;i=t._order;a=[c*(i%s),d*Math.floor(i/s)],r=a[0],l=a[1];a=[r+c*n/2,l+d*n/2],r=a[0],l=a[1];return"translate("+r+", "+l+")"});this.g.view.selectAll("g.data").each(function(t,e){var n,i;if(t._removing){return}n=u.padding||0;i=Math.min(c*(1-n)/256,d*(1-n)/256);return o.select(this).select("use.data").transition().duration(350).attr("fill",function(t,e){return a.get(t.cat)}).attr("opacity",1).attr("x",0).attr("y",0).attr("transform","scale("+i+","+i+")").attr("href","#glyph")});t=this.p?this.p:Promise.resolve();this.p=t.then(function(){var t,e;t=(l.cfg.shape.glyph||[])[0]||{};e=t.dataurl||sampleIcon;return utils.traceSvg({file:e,light:l.cfg.shape.threshold})}).then(function(t){var e,n;e=document.createElement("div");e.innerHTML=t;n=e.querySelector("g").cloneNode(true);n.setAttribute("id","glyph");n.removeAttribute("fill");l.svg.querySelector("g.defs defs").innerHTML="";return l.svg.querySelector("g.defs defs").appendChild(n)});return this.legend.render()}}};</script></div>